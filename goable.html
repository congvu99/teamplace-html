<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earth Particles</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script>
    // Scene, Camera, Renderer
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 300;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Tải ảnh bản đồ Trái Đất (ảnh phẳng)
    const earthMapURL = 'https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg';
    const loader = new THREE.TextureLoader();
    loader.load(earthMapURL, (texture) => {
      // Lấy dữ liệu pixel từ ảnh
      const image = texture.image;
      const canvas = document.createElement('canvas');
      canvas.width = image.width;
      canvas.height = image.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(image, 0, 0);
      const imageData = ctx.getImageData(0, 0, image.width, image.height).data;

      // Tạo các điểm trên bề mặt quả cầu
      const radius = 80; // giảm bán kính từ 150 xuống 80
      const numPoints = 20000; // tăng mật độ điểm
      const positions = [];

      for (let i = 0; i < numPoints; i++) {
        // Chọn vị trí ngẫu nhiên trên mặt cầu
        const theta = Math.random() * 2 * Math.PI; // kinh độ
        const phi = Math.acos(2 * Math.random() - 1); // vĩ độ

        // Lấy pixel tương ứng trong bản đồ (texture là dạng equirectangular)
        const u = theta / (2 * Math.PI);
        const v = phi / Math.PI;
        const xPix = Math.floor(u * image.width);
        const yPix = Math.floor((1 - v) * image.height); // lật trục Y
        const idx = (yPix * image.width + xPix) * 4;

        const r = imageData[idx];
        const g = imageData[idx + 1];
        const b = imageData[idx + 2];

        // Kiểm tra pixel có phải đất liền không (gần xanh biển thì bỏ)
        if (!(b > g && b > r)) {
          // Chuyển đổi sang tọa độ 3D
          const x = radius * Math.sin(phi) * Math.cos(theta);
          const y = radius * Math.cos(phi);
          const z = radius * Math.sin(phi) * Math.sin(theta);
          positions.push(x, y, z);
        }
      }

      // BufferGeometry để lưu điểm
      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));

      // Vật liệu cho điểm
      const material = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 0.7 // làm dấu chấm nhỏ lại
      });

      const earthPoints = new THREE.Points(geometry, material);
      scene.add(earthPoints);

      // Animate
      function animate() {
        requestAnimationFrame(animate);
        earthPoints.rotation.y += 0.002; // quay
        renderer.render(scene, camera);
      }
      animate();
    });

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
